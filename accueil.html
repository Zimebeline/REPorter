<!DOCTYPE html>
<link rel="stylesheet" type="text/css" href="style.css">
<center>
<HEAD>
	 <meta charset="utf-8">
	<h1> &nbsp; Envoi d'un rapport </h1>
	<div id = "box">
		<input id = "mel" type="email" name="mel"  placeholder="example@email.com" required="true" autocomplete= "on"> 
	</div>

	<hr width="300" align="center">

	<div id = "box">
		<input id = "first" type="text" name="objet"  placeholder="Objet :" required="true"> 
	</div>

</HEAD>
<hr width="300" align="center">
<BODY>

		<div id = "box">		
			<textarea id = "last" type="text" name="description" placeholder= "Description..."rows="5" cols=" 33"></textarea>
		</div>

		<hr width="300" align="center">

		<div id="halfbox">
			<button id="annuler" onclick="document.location.reload(true)" type="text" name="annuler"> Annuler </button>
		</div>

		<div id="halfbox">
			<button type ="button" onclick="sendTo();" id="valider"  type="text" name="valider" > Valider </button>
<br> <br> <br>
		</div>

		<div id="halfbox">
			<button type = "text" id = "recevoir" name = "Recevoir " onclick="receive()">  Recevoir </button>
		</div>

<script language="JavaScript" >
	function sendTo()
	{
		mel = document.getElementById("mel").value;	
		desc = document.getElementById("last").value;
		obj = document.getElementById("first").value;
		sender = sessionStorage.getItem("identity");


		var data ={
			desc: desc,
			obj : obj,
			sender : sender
		};

		newDATA = JSON.stringify(data);
		
		if (last(mel) != "ErrorExisting")
		{
		localStorage.setItem(last(mel), newDATA);
		alert("Vous avez envoyé un mail à : \n" + mel + "\n le message suivant : \n" + data.obj + " \n" + data.desc);
		}
		else
		{
				alert("Message déjà existant");
		}

		// Recupère la fin de la liste chainée et vérifie que le message n'existe pas déjà
		
	}
	function last(message)
		{
			if(newDATA != message)
			{
				if(localStorage.getItem(message) == null)
					return message;
				else
					return last(localStorage.getItem(message));
			}
			else
			{
				return ("ErrorExisting");
			}	
				
		}

	function receive()
		{
			identity =sessionStorage.getItem("identity");
			if(identity != null)
			{
				message = localStorage.getItem(identity);
				i = 0;

				document.writeln("<link rel=\"stylesheet\" type=\"text/css\" href=\"style.css\">");
				document.writeln("<center>");
					while(message != null)
					{
					i++;
					parseMessage = JSON.parse(message);
					document.writeln("<div id = \"box\" >");		
						//	document.writeln('<button id="supprimer"  onclick="deleting(' + i + ')" > X </button>');
							document.writeln("<h1>" + parseMessage.sender +  "</h1>");
							document.writeln("<h2>" + parseMessage.obj +  "</h2>");
							document.writeln("<h2>" + parseMessage.desc +  "</h2>");																		
					document.writeln("</div>");
					message = localStorage.getItem(message);
					}	
				document.writeln("</center>");

			/*	document.write("<BODY>");
				document.write("<script>");
				document.writeln(supprimer);
				document.writeln(previous);
				document.writeln(insert);
				document.writeln(deleting);
				document.write("<\/script>");
				document.write("</BODY>"); */ 
			}
			else
			{
				alert("Veuillez vous reconnecter");
			}
		}

/*
		function deleting(num)
		{
			alert("Etes vous sur de vouloir supprimer ?");
			identity = sessionStorage.getItem("identity");
			i = 0;
			do
			{
				//trouver 2 et 4 
				i++;
				myMSG = localStorage.getItem(myMSG);
				nextMSG = localStorage.getItem(myMSG);
			}	
			while(num == i && nextMSG =! null);
			// coller 2 avec 4 

			//supprimer 3
			theMSG = myMSG;
			localStorage.
		}
		*/
function deleting(num)
		{
			alert("Etes vous sur de vouloir supprimer ?");
			identity = sessionStorage.getItem("identity");
			myMSG = localStorage.getItem(identity);
			i = 1;
			while(i =! num)
			{
				i++;
				myMSG = localStorage.getItem(myMSG);
			}
			localStorage.removeItem(myMSG);
			//supprimer(myMSG);
		}
		
			function supprimer(msg)
		{
			next = localStorage.getItem(msg);		
			insert(previous(msg), next);
			localStorage.removeItem(msg);
		}

		function previous(message)
		{
			identity = sessionStorage.getItem("identity");
			myMSG = localStorage.getItem(identity);
			while (localStorage.getItem(myMSG) != message || myMSG == null)
			{
				myMSG = localStorage.getItem(myMSG);
			};
			return myMSG;
		}
		//Regarder dans le stockage si la valeur est correcte

		//Continuer sur Commenter()
		function insert(point, newData)
		{
			suivant = localStorage.getItem(point);
			localStorage.setItem(point, newData);
			localStorage.setItem(newData, suivant);
		}
		// Essayer d'insérer un message

/*		function sort()






/*		function sort()
		{


		}
	*/
</script>
</BODY>
</center>
